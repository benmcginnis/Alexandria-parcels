name: Deploy to Cloudflare

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      upload_data:
        description: 'Force upload data files to R2'
        required: false
        default: 'false'
        type: boolean

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy Worker and Pages

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build splitter
        run: npm run build

      - name: Build React app
        run: npm run build:vite

      - name: Build Worker
        run: npm run build:worker

      - name: Deploy Worker
        run: npx wrangler deploy --config wrangler.worker.toml
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Upload data to R2
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.upload_data == 'true' || github.event_name == 'push'
        run: |
          # Upload manifest if it exists and has changed
          if [ -f "data/manifest.json" ]; then
            if git diff --quiet HEAD~1 HEAD -- data/manifest.json 2>/dev/null || [ "${{ github.event_name }}" = "push" ] && [ "${{ github.event.before }}" = "0000000000000000000000000000000000000000" ]; then
              echo "Uploading manifest.json (changed or new)..."
              npx wrangler r2 object put alexandria-parcels-data/manifest.json --file data/manifest.json
            else
              echo "Skipping manifest.json (unchanged)"
            fi
          fi
          
          # Upload only changed batch files using git diff
          for i in {1..50}; do
            batch_file="data/alexandria_parcels_batch_$(printf "%03d" $i).geojson.gz"
            if [ -f "$batch_file" ]; then
              # Check if file changed in this commit
              if git diff --quiet HEAD~1 HEAD -- "$batch_file" 2>/dev/null || [ "${{ github.event_name }}" = "push" ] && [ "${{ github.event.before }}" = "0000000000000000000000000000000000000000" ]; then
                echo "Uploading $batch_file (changed or new)..."
                npx wrangler r2 object put "alexandria-parcels-data/alexandria_parcels_batch_$(printf "%03d" $i).geojson.gz" --file "$batch_file"
              else
                echo "Skipping $batch_file (unchanged)"
              fi
            fi
          done
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Deploy Pages
        run: npx wrangler pages deploy dist/client --project-name alexandria-parcels --commit-dirty=true
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
